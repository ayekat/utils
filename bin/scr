#!/bin/sh --

# Script for simplifying on-the-go addition of a VGA/HDMI-monitor to my laptop.
# Written by ayekat on a boring january day; improved in october 2013; improved
# again to support HDMI screens in april 2014.

set -eu

# Basic values:
APPNAME="$(basename "$0")"
LCDNAME=LVDS-1

E_SUCCESS=0
E_USER=1
E_CONN=2
E_INTERNAL=13

scr_add()
{
	# Mode:
	modeline="$(xrandr | grep -A 1 "$SCRNAME connected" | tail -n +2)"
	test -n "$modeline" || die $E_CONN '%s is not connected' "$SCRNAME"

	# Position:
	position="$1"
	case "$position" in
		(right|left) position="$position-of";;
	esac
	xrandr --output "$LCDNAME" --auto || exit 1
	xrandr --output "$SCRNAME" --auto --"$position" "$LCDNAME" --primary || exit 1
	scr_setup
}

scr_remove() {
	printf 'Removing %s...\n' "$SCRNAME"
	xrandr --output "$SCRNAME" --off \
		|| die $E_CONN 'Could not remove %s' "$SCRNAME"
	scr_setup
}

scr_setup()
{
	xrandr --output "$LCDNAME" --dpi 96
	nitrogen --restore
}

print_help()
{
	cat <<- EOF
	$APPNAME: Quickly add/remove external screens

	Usage: $APPNAME add {right|left|above|below}
	       $APPNAME remove
	EOF
}

die()
{
	retval=$(($1)); shift
	printf "$@" >&2; echo >&2
	if [ $retval -eq $E_USER ]; then
		echo 'Run with -h for more detail' >&2
	fi
	exit $retval
}

# What kind of screen?
case "$APPNAME" in
	(vga) SCRNAME=VGA-1 ;;
	(hdmi) SCRNAME=HDMI-1 ;;
	(dp) SCRNAME=DP-1 ;;
	(*) die $E_USER 'Please invoke this script as vga, hdmi or dp' ;;
esac

# Options:
while getopts :h opt; do
	case "$opt" in
		(h) print_help; exit $E_SUCCESS ;;
		(:) die $E_USER 'Missing argument for -%s' "$OPTARG" ;;
		('?') die $E_USER 'Unknown option -%s' "$OPTARG" ;;
		(*) die $E_INTERNAL 'Unhandled option -%s' "$OPTARG" ;;
	esac
done
test $# -gt 0 || die $E_USER 'Please provide a command'
cmd="$1"; shift

# Action:
case "$cmd" in
	(add)
		test $# -gt 0 || die $E_USER 'Please provide a position'
		scr_add "$@"
		;;
	(remove)
		test $# -eq 0 || die $E_USER 'Trailing arguments: %s' "$*"
		scr_remove
		;;
	(*)
		die $E_USER 'Unknown command: %s' "$cmd"
		;;
esac

