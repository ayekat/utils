#!/usr/bin/env sh

# Constants:
APPNAME="$(basename "$0")"
E_USER=1
E_INTERN=255
if case "$APPNAME" in (sum|avg) false ;; esac; then
	die $E_INTERN 'Unknown command: %s' "$APPNAME"
fi

# Default values:
precision=0
summands=''

die()
{
	retval=$1; shift
	format="$1"; shift
	printf "$format\n" "$@" >&2
	printf "Run with --help for usage.\n" >&2
	exit $retval
}

usage()
{
	case "$APPNAME" in
		sum) echo "$APPNAME: sum up numeric values" ;;
		avg) echo "$APPNAME: calculate average value of numeric values" ;;
	esac
	cat <<- EOF

	Usage: $APPNAME [OPTIONS] VALUES ...

	Options:
	  -h, --help           Display this help and exit
	  -p, --precision NUM  Display NUM digits after the decimal point [default=$precision]
	EOF
}

# Read arguments:
while [ $# -gt 0 ]; do
	case "$1" in
		-h|--help) usage; exit 0 ;;
		-p|--precision) shift; precision="$1" ;;
		-*) die $E_USER 'Unknown option: %s' "$1" ;;
		*) break ;;
	esac
	shift
done
case "$precision" in
	*[!0-9]*) die $E_USER 'Non-numeric value for precision: %s' "$precision"
esac
if [ $# -eq 0 ]; then
	die $E_USER 'Empty list of arguments'
fi

# Sum up:
for i in "$@"; do
	summands="${summands}${i} + "
done

# Calculate:
case "$APPNAME" in
	sum) dc -e "$precision k 0 $summands p" ;;
	avg) dc -e "$precision k 0 $summands $# / p" ;;
esac
