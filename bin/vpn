#!/usr/bin/env sh

# Simple frontend to openvpn - takes a hostname and reads the corresponding
# configuration file from $HOME/.local/etc/openvpn

# Written by ayekat on a cool monday afternoon in may 2016

HOME="${HOME:-$(getent passwd "$(id -u)" | cut -d: -f6)}"
XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"

CONFDIR="$XDG_CONFIG_HOME/openvpn"
APPNAME="$(basename "$0")"
E_SUCCESS=0
E_FAIL=1
E_USER=2
E_PERM=3


usage()
{
	cat <<- EOF
	$APPNAME: Establish a VPN connection to a host

	Usage: $APPNAME [OPTIONS] HOST

	Options:
	  -h, --help      Display this message and exit

	The host configuration is an openvpn configuration file located under $CONFDIR
	See openvpn(1) for more information.
	EOF
}

die()
{
	retval=$1; shift
	printf "$@" >&2; echo >&2
	if [ $retval -eq $E_USER ]; then
		printf 'Run with -h for help.\n' >&2
	fi
	exit $retval
}

# Read arguments:
while [ $# -gt 0 ]; do
	case "$1" in
		(-h|--help) usage; exit $E_SUCCESS ;;
		(-*) die $E_USER 'Unknown option: %s' "$1" ;;
		(*) break ;;
	esac
	shift
done
host="$1"
test -n "$host" || die $E_USER 'Please specify a host'

# Check environment:
hostdir="$CONFDIR/$host"
test -d "$hostdir" || die $E_FAIL '%s: No such directory' "$hostdir"
test -r "$hostdir" || die $E_PERM '%s: Permission denied' "$hostdir"
hostfile="$hostdir/$host.ovpn"
test -e "$hostfile" || die $E_FAIL '%s: No such file' "$hostfile"

# Open RDP connection:
cd "$hostdir"
sudo openvpn --dev tun0 --config "$hostfile"
