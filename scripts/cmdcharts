#!/usr/bin/env sh

# Print most used commands.

SCRIPTFILE="$(basename "$0")"

die()
{
	die_retval=$1
	die_format="$2"
	shift 2
	printf "$die_format" "$@" >&2
	exit $retval
}

chart()
{
	[ -n "$HISTFILE" ] || die 2 "HISTFILE undefined: can't locate shell history"
	[ -e "$HISTFILE" ] || die 2 '%s not found' "$HISTFILE"
	if [ -z "$COMMAND" ]; then
		awk '{print $1}' < "$HISTFILE"
	else
		grep --text "^$COMMAND" "$HISTFILE" | awk "{print \$$(($COMMANDLEN+1))}"
	fi | sort | uniq -c | sort -rn | head -n "$NLINES"
}

usage()
{
	cat >&2 <<- EOF
	$SCRIPTFILE: list most used commands

	Usage: $SCRIPTFILE [OPTIONS] [COMMAND]

	Options:
	    -h            Display this help
	    -n NLINES     List NLINES most used commands [default=$NLINES]

	Command:
	    If present, display commands with COMMAND as suffix (e.g. sudo, git, vim)
	EOF
	exit 1
}

main()
{
	NLINES=10
	COMMAND=''

	# Options
	while getopts hn: opt; do
		case "$opt" in
			h) usage ;;
			n) NLINES="$OPTARG" ;;
			*) usage ;;
		esac
	done
	shift $(($OPTIND - 1))

	# Command:
	COMMAND="$@"
	COMMANDLEN=$#
	[ -n "$COMMAND" ] && shift

	# Test validity:
	#test $# -eq 0 || die 1 'Trailing arguments: %s' "$@"

	chart
}

main "$@"
