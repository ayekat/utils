#!/usr/bin/env sh

APPNAME="$(basename "$(readlink -f "$0")")"

# Default environment variables - see man pass (1):
export PASSWORD_STORE_DIR="${PASSWORD_STORE_DIR:-$HOME/.password-store}"
export PASSWORD_STORE_CLIP_TIME="${PASSWORD_STORE_CLIP_TIME:-45}"

die()
{
	printf "[%s] %s: %s\n" "$(date '+%Y-%m-%d,%H:%M:%S')" "$APPNAME" "$1" >&2
	exit 1
}

# Environment:
[ -d "$PASSWORD_STORE_DIR" ] || die "No such directory: $PASSWORD_STORE_DIR"
[ -r "$PASSWORD_STORE_DIR" ] || die "Read permission denied: $PASSWORD_STORE_DIR"
cd "$PASSWORD_STORE_DIR" || die "Cannot not browse $PASSWORD_STORE_DIR"

# Get password name:
passname="$(find -L ./* -type f | sed 's/\.gpg$//g' | sort | dmenu "$@")"
[ -n "$passname" ] || die 'No password selected; exiting.'

# Copy to clipboard and notify user:
if pass show -c "$passname"; then
	notify-send \
		'Unix pass' \
		"$passname\n(will clear in $PASSWORD_STORE_CLIP_TIME seconds)"
else
	die 'Pass failed for unknown reasons.'
fi

# Type:
sleep 0.1 && xclip -o -selection clipboard | xdotool type --file -
