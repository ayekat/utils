#!/usr/bin/env sh

# Simple frontend to openvpn - takes a hostname and reads the corresponding
# configuration file from $HOME/.local/etc/openvpn

# Written by ayekat on a cool monday afternoon in may 2016

ETCDIR="${ETCDIR:-"$HOME/.local/etc"}"
CONFDIR="$ETCDIR/openvpn"
APPNAME="$(basename "$0")"

E_SUCCESS=0
E_FAIL=1
E_USER=2
E_PERM=3

usage() { echo "Usage: $APPNAME [OPTIONS] HOST"; }

help()
{
	echo "$APPNAME: Establish a VPN connection to a host"
	echo
	usage
	echo
	cat <<- EOF
	Options:
	  -h, --help      Display this message and exit

	The host configuration is an openvpn configuration file located under $CONFDIR
	See openvpn(1) for more information.
	EOF
}

die()
{
	retval_str=$1
	retval=$(eval "echo \$$retval_str")
	shift
	format="$1"
	if [ -n "$format" ]; then
		shift
		printf "\033[31m$retval_str\033[0m $format\n" "$@" >&2
	fi
	if [ $retval = E_USER ]; then
		usage >&2
	fi
	exit $retval
}

# Read arguments:
while [ $# -gt 0 ]; do
	case "$1" in
		-h|--help) help; exit 0 ;;
		-*) die E_USER "Unknown option: -$1" ;;
		*) break ;;
	esac
	shift
done
host="$1"
test -n "$host" || die E_USER "Please specify a host"

# Check environment:
hostdir="$CONFDIR/$host"
test -d "$hostdir" || die E_FAIL "$hostdir: No such directory"
test -r "$hostdir" || die E_PERM "$hostdir: Permission denied"
hostfile="$hostdir/${host}.ovpn"
test -e "$hostfile" || die E_FAIL "$hostfile: No such file"

# Open RDP connection:
cd "$hostdir"
sudo openvpn --dev tun0 --config "$hostfile"
