#!/usr/bin/env sh

# Set the X input according to ayekat's preferences.
# Written by ayekat on an annoying Monday afternoon in May 2015.

set -e

# Constants:
APPNAME="$(basename "$0")"
XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
E_USER=1
TRUE=1
FALSE=0
NULL=/dev/null

# Default values:
swapmouse=$FALSE
swapescape=$FALSE
layout='ch'
xmodmaprc="$XDG_CONFIG_HOME/X11/xmodmaprc"

ayeinput_keyboard()
{
	case $swapescape in
		$TRUE)  setxkbmap -layout "$layout" -option caps:swapescape ;;
		$FALSE) setxkbmap -layout "$layout" ;;
	esac

	if [ "$xmodmaprc" != "$NULL" ]; then
		xmodmap "$xmodmaprc"
	fi
}

ayeinput_mouse()
{
	# Layout of mouse buttons:
	if [ $swapmouse -eq $TRUE ]; then
		mouse_primary='3 2 1'
	else
		mouse_primary='1 2 3'
	fi
	if [ "$(hostname)" = 'ixh' ]; then
		dev='TPPS/2 IBM TrackPoint'
		ptr="$mouse_primary 4 5 6 7 8 9 10"
		tmo='200'
	else
		dev='pointer:Lenovo ThinkPad Compact USB Keyboard with TrackPoint'
		ptr="$mouse_primary 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22"
		tmo='0'
	fi
	xmodmap -e "pointer = $ptr"

	# Enable scrolling through middle click + trackpad:
	xinput set-prop "$dev" 'Evdev Wheel Emulation' 1
	xinput set-prop "$dev" 'Evdev Wheel Emulation Button' 2
	xinput set-prop "$dev" 'Evdev Wheel Emulation Axes' 6 7 4 5
	xinput set-prop "$dev" 'Evdev Wheel Emulation Timeout' $tmo

	# Enable middle click drag&drop (work-around for above option):
	xinput set-prop "$dev" 'Evdev Middle Button Emulation' 1
}

# MAIN =========================================================================

die()
{
	retval=$1; shift
	format="$1"; shift
	printf "$format\n" "$@" >&2
	if [ $retval -eq $E_USER ]; then
		printf "Run with -h for usage.\n" >&2
	fi
	exit $retval
}

usage()
{
	echo "Usage: $APPNAME [OPTIONS ...]"
	cat <<- EOF

	Set keyboard/mouse layout the way ayekat likes it :-)

	Options:
	  -h            Display this help and exit
	  -e            Swap Escape with Caps Lock
	  -l LAYOUT     Set layout [default=$layout]
	  -m            Swap left/right mouse button
	  -x XMODMAPRC  Path to xmodmaprc [default=$xmodmaprc]
	EOF
}

# Read arguments:
while getopts :ehl:mx: opt; do
	case "$opt" in
		e) swapescape=$TRUE ;;
		h) usage; exit 0 ;;
		l) layout="$OPTARG" ;;
		m) swapmouse=$TRUE ;;
		x) xmodmaprc="$OPTARG" ;;
		'?') die $E_USER 'Unknown option: -%s' "$OPTARG" ;;
	esac
done
argshift=$((OPTIND - 1))

# Check arguments:
test -f "$xmodmaprc" || die 1 '%s: file not found' "$xmodmaprc"
test -r "$xmodmaprc" || die 1 '%s: permission denied' "$xmodmaprc"
shift $argshift
test $# -eq 0 || die $E_USER "trailing arguments: $@"

# Set keyboard/mouse options:
ayeinput_keyboard
ayeinput_mouse
